# GitHub Actions CI/CD ç®¡é“
# è‡ªå‹•å»ºæ§‹ Docker æ˜ åƒä¸¦æ¨é€åˆ° GitHub Container Registry

name: Docker Build and Push

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*.*.*' ]
  
  # ç•¶å»ºç«‹ Pull Request æ™‚è§¸ç™¼ï¼ˆåƒ…å»ºæ§‹ï¼Œä¸æ¨é€ï¼‰
  pull_request:
    branches: [ "main", "master" ]
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

env:
  # GitHub Container Registry
  REGISTRY: ghcr.io
  # æ˜ åƒåç¨±ï¼ˆæœƒè‡ªå‹•ä½¿ç”¨å€‰åº«åç¨±ï¼‰
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­å®š Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£ UV
      run: pip install uv
    
    - name: å®‰è£ä¾è³´
      run: uv sync --frozen
    
    - name: ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (Ruff)
      run: |
        uv run ruff check src/
        uv run ruff format --check src/
      continue-on-error: true  # æš«æ™‚å…è¨±é¢¨æ ¼æª¢æŸ¥å¤±æ•—
    
    - name: é¡å‹æª¢æŸ¥ (mypy)
      run: uv run mypy src/
      continue-on-error: true  # æš«æ™‚å…è¨±é¡å‹æª¢æŸ¥å¤±æ•—
    
    - name: åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
      run: |
        # å»ºç«‹æ¸¬è©¦ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
        cp .env.example .env
        
        # æ¸¬è©¦é…ç½®è¼‰å…¥
        uv run python -c "
        import sys
        sys.path.insert(0, 'src')
        from config import config_manager
        config_manager.load_config()
        print('âœ… é…ç½®ç³»çµ±æ­£å¸¸')
        "
        
        # æ¸¬è©¦æ¨¡çµ„è¼‰å…¥
        uv run python -c "
        import sys
        sys.path.insert(0, 'src')
        from punch_clock import AoaCloudPunchClock
        from scheduler import scheduler_manager
        from models import PunchAction
        print('âœ… æ¨¡çµ„è¼‰å…¥æ­£å¸¸')
        "

  # Docker å»ºæ§‹å’Œæ¨é€
  docker-build-push:
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­å®š Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ç™»å…¥ Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æå– metadataï¼ˆæ¨™ç±¤ã€æ¨™è¨˜ï¼‰
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: å»ºæ§‹å’Œæ¨é€ Docker æ˜ åƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        target: runtime

  # å®‰å…¨æ€§æƒæ
  security-scan:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
    - name: è¨­å®šæ˜ åƒåç¨±
      id: image
      run: |
        IMAGE_NAME=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" | tr '[:upper:]' '[:lower:]')
        echo "name=$IMAGE_NAME" >> $GITHUB_OUTPUT
    
    - name: åŸ·è¡Œ Trivy æ¼æ´æƒæ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.image.outputs.name }}
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ä¸Šå‚³ Trivy æƒæçµæœåˆ° GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # éƒ¨ç½²ï¼ˆåƒ…åœ¨ main/master åˆ†æ”¯ï¼‰
  deploy:
    needs: [docker-build-push, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²æµç¨‹é–‹å§‹..."
        echo "ğŸ“¦ æ˜ åƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        
        # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éƒ¨ç½²è…³æœ¬
        # ä¾‹å¦‚ï¼šé€£æ¥åˆ°é ç«¯ä¼ºæœå™¨ä¸¦æ›´æ–°å®¹å™¨
        
        echo "âœ… éƒ¨ç½²å®Œæˆ"

# ============================================
# ä½¿ç”¨èªªæ˜
# ============================================
#
# 1. æ­¤å·¥ä½œæµç¨‹æœƒåœ¨ä»¥ä¸‹æƒ…æ³è‡ªå‹•åŸ·è¡Œï¼š
#    - æ¨é€åˆ° main/master åˆ†æ”¯
#    - å»ºç«‹ Pull Request
#    - å»ºç«‹ç‰ˆæœ¬æ¨™ç±¤ (v*.*.*)
#    - æ‰‹å‹•è§¸ç™¼
#
# 2. å·¥ä½œæµç¨‹åŒ…å«ä»¥ä¸‹æ­¥é©Ÿï¼š
#    - ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ï¼ˆruff, mypyï¼‰
#    - Docker æ˜ åƒå»ºæ§‹å’Œæ¨é€
#    - å®‰å…¨æ€§æ¼æ´æƒæ
#    - è‡ªå‹•éƒ¨ç½²ï¼ˆåƒ… main/master åˆ†æ”¯ï¼‰
#
# 3. æ˜ åƒæœƒæ¨é€åˆ° GitHub Container Registryï¼š
#    ghcr.io/your-username/aoacloudpunchio:latest
#
# 4. å¦‚éœ€ä½¿ç”¨æ­¤æ˜ åƒï¼š
#    docker pull ghcr.io/your-username/aoacloudpunchio:latest
#
# 5. éœ€è¦çš„ GitHub Secretsï¼š
#    - GITHUB_TOKENï¼ˆè‡ªå‹•æä¾›ï¼‰
#    - å…¶ä»–éƒ¨ç½²ç›¸é—œçš„ secretsï¼ˆå¦‚éœ€è¦ï¼‰

# ============================================
# é€²éšé…ç½®é¸é …
# ============================================
#
# 1. å¤šç’°å¢ƒéƒ¨ç½²ï¼š
#    - å¯ä»¥å»ºç«‹ä¸åŒçš„ environmentï¼ˆdev, staging, prodï¼‰
#    - æ¯å€‹ç’°å¢ƒå¯ä»¥æœ‰ä¸åŒçš„éƒ¨ç½²è…³æœ¬å’Œ secrets
#
# 2. æ¢ä»¶å¼éƒ¨ç½²ï¼š
#    - å¯ä»¥æ ¹æ“šåˆ†æ”¯ã€æ¨™ç±¤æˆ–æª”æ¡ˆè®Šæ›´ä¾†æ±ºå®šæ˜¯å¦éƒ¨ç½²
#
# 3. é€šçŸ¥æ•´åˆï¼š
#    - å¯ä»¥æ•´åˆ Slackã€Teams ç­‰é€šçŸ¥æœå‹™
#    - éƒ¨ç½²æˆåŠŸ/å¤±æ•—æ™‚ç™¼é€é€šçŸ¥
#
# 4. æ¸¬è©¦æ•´åˆï¼š
#    - å¯ä»¥æ·»åŠ æ•´åˆæ¸¬è©¦æ­¥é©Ÿ
#    - åœ¨éƒ¨ç½²å‰åŸ·è¡Œ smoke test